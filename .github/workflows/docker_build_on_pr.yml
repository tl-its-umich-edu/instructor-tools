name: Docker Build on PR

on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build . -f Dockerfile

      - name: Create minimal .env for tests
        run: |
          cat > .env << EOF
          ALLOWED_HOSTS=localhost,127.0.0.1
          DEBUG=True
          CANVAS_OAUTH_CLIENT_ID=test_client_id
          CANVAS_OAUTH_CLIENT_SECRET=test_client_secret
          CANVAS_OAUTH_CANVAS_DOMAIN=test.instructure.com
          EOF

      - name: Start services
        run: docker compose up -d

      - name: Run decorator tests
        run: docker compose exec -T web python manage.py test backend.tests.test_decorators

      - name: Cleanup
        if: always()
        run: docker compose down